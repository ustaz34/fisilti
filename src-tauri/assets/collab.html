<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#070b1a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Fisilti — Canli Transkripsiyon</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#070b1a;--bg2:#0d1229;--accent:#fae4cf;--accent-rgb:250,228,207;
  --green:#34d399;--amber:#f59e0b;--red:#ef4444;--glass:rgba(255,255,255,0.03);
  --glass-border:rgba(255,255,255,0.06);
}
body{
  background:var(--bg);color:#e8e0d6;
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  min-height:100dvh;display:flex;flex-direction:column;overflow:hidden;
  position:relative;
}
/* Animated gradient background */
.bg-glow{
  position:fixed;top:-50%;left:-50%;width:200%;height:200%;
  background:radial-gradient(circle at 30% 40%, rgba(var(--accent-rgb),0.03) 0%, transparent 50%),
             radial-gradient(circle at 70% 60%, rgba(52,211,153,0.02) 0%, transparent 50%);
  animation:bgFloat 20s ease-in-out infinite;z-index:0;pointer-events:none;
}
@keyframes bgFloat{
  0%,100%{transform:translate(0,0) rotate(0deg)}
  33%{transform:translate(2%,-2%) rotate(1deg)}
  66%{transform:translate(-1%,1%) rotate(-1deg)}
}
/* Header */
.header{
  position:relative;z-index:2;
  padding:env(safe-area-inset-top, 12px) 20px 12px;
  display:flex;align-items:center;gap:10px;
  background:rgba(7,11,26,0.8);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-bottom:1px solid var(--glass-border);
}
.header svg{flex-shrink:0;opacity:0.6}
.header h1{font-size:16px;font-weight:700;color:var(--accent);letter-spacing:0.5px}
.header-right{margin-left:auto;display:flex;gap:6px}
.icon-btn{
  width:32px;height:32px;border-radius:10px;border:none;
  background:var(--glass);color:rgba(255,255,255,0.4);
  display:flex;align-items:center;justify-content:center;cursor:pointer;
  transition:all 0.2s;
}
.icon-btn:active{transform:scale(0.9);background:rgba(255,255,255,0.08)}
.icon-btn.active{color:var(--accent);background:rgba(var(--accent-rgb),0.1)}
/* Status bar */
.status-bar{
  position:relative;z-index:2;
  padding:10px 20px;display:flex;align-items:center;gap:10px;
  background:rgba(13,18,41,0.6);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  border-bottom:1px solid var(--glass-border);
}
.status-dot{
  width:8px;height:8px;border-radius:50%;flex-shrink:0;
  transition:all 0.4s ease;
}
.status-dot.connecting{background:var(--amber);animation:pulse 1.2s infinite;box-shadow:0 0 12px rgba(245,158,11,0.3)}
.status-dot.connected{background:var(--green);box-shadow:0 0 12px rgba(52,211,153,0.4)}
.status-dot.disconnected{background:var(--red);box-shadow:0 0 8px rgba(239,68,68,0.3)}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.4;transform:scale(0.8)}}
.status-text{font-size:12px;color:rgba(255,255,255,0.4);flex:1}
.status-meta{font-size:10px;color:rgba(255,255,255,0.15);font-variant-numeric:tabular-nums}
/* Live pulse ring */
.pulse-ring{
  position:absolute;left:20px;top:50%;transform:translateY(-50%);
  width:24px;height:24px;border-radius:50%;
  border:1.5px solid var(--green);opacity:0;
  animation:ringPulse 2s ease-out infinite;pointer-events:none;
}
.pulse-ring.hidden{display:none}
@keyframes ringPulse{0%{opacity:0.5;transform:translateY(-50%) scale(0.5)}100%{opacity:0;transform:translateY(-50%) scale(2)}}
/* Transcript area */
.transcript-area{
  position:relative;z-index:1;
  flex:1;overflow-y:auto;padding:16px 20px 100px;
  -webkit-overflow-scrolling:touch;scroll-behavior:smooth;
}
.msg-block{
  margin-bottom:12px;padding:12px 14px;border-radius:14px;
  background:var(--glass);border:1px solid var(--glass-border);
  animation:msgIn 0.4s cubic-bezier(0.16,1,0.3,1);
  transition:border-color 0.3s;
}
.msg-block:last-child{border-color:rgba(var(--accent-rgb),0.12)}
.msg-block .time{
  font-size:9px;color:rgba(255,255,255,0.15);margin-bottom:4px;
  font-variant-numeric:tabular-nums;letter-spacing:0.5px;
}
.msg-block .text{
  font-size:15px;line-height:1.7;color:rgba(255,255,255,0.75);
  white-space:pre-wrap;word-break:break-word;
}
@keyframes msgIn{
  from{opacity:0;transform:translateY(12px) scale(0.97)}
  to{opacity:1;transform:translateY(0) scale(1)}
}
/* Empty state */
.empty-state{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:16px;padding:40px 20px;text-align:center;position:relative;z-index:1;
}
.empty-icon{
  width:64px;height:64px;border-radius:20px;
  background:var(--glass);border:1px solid var(--glass-border);
  display:flex;align-items:center;justify-content:center;
  animation:float 3s ease-in-out infinite;
}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
.empty-state .title{font-size:14px;color:rgba(255,255,255,0.3);font-weight:600}
.empty-state .desc{font-size:12px;color:rgba(255,255,255,0.15);max-width:260px;line-height:1.5}
/* Error box */
.error-box{
  margin:20px;padding:20px;border-radius:16px;text-align:center;
  background:rgba(239,68,68,0.04);border:1px solid rgba(239,68,68,0.1);
  position:relative;z-index:1;
}
.error-box h2{font-size:14px;color:rgba(239,68,68,0.8);margin-bottom:8px;font-weight:600}
.error-box p{font-size:12px;color:rgba(255,255,255,0.3);line-height:1.6}
.error-box .retry-btn{
  margin-top:14px;padding:8px 24px;border-radius:10px;border:none;
  background:rgba(239,68,68,0.1);color:rgba(239,68,68,0.7);
  font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;
}
.error-box .retry-btn:active{transform:scale(0.95);background:rgba(239,68,68,0.2)}
/* Bottom bar (floating) */
.bottom-bar{
  position:fixed;bottom:0;left:0;right:0;z-index:10;
  padding:12px 20px calc(env(safe-area-inset-bottom, 8px) + 12px);
  background:linear-gradient(transparent, rgba(7,11,26,0.95) 30%);
  display:flex;align-items:center;gap:8px;
}
.stats{
  flex:1;display:flex;flex-direction:column;gap:2px;
}
.stats span{font-size:9px;color:rgba(255,255,255,0.15);font-variant-numeric:tabular-nums}
.action-btn{
  height:36px;padding:0 16px;border-radius:12px;border:none;
  font-size:11px;font-weight:600;cursor:pointer;
  display:flex;align-items:center;gap:6px;transition:all 0.2s;
}
.action-btn:active{transform:scale(0.95)}
.action-btn.copy{
  background:rgba(var(--accent-rgb),0.08);color:rgba(var(--accent-rgb),0.7);
}
.action-btn.share{
  background:rgba(52,211,153,0.08);color:rgba(52,211,153,0.7);
}
/* Toast */
.toast{
  position:fixed;top:80px;left:50%;transform:translateX(-50%) translateY(-20px);
  padding:8px 18px;border-radius:12px;z-index:100;
  background:rgba(var(--accent-rgb),0.12);backdrop-filter:blur(12px);
  border:1px solid rgba(var(--accent-rgb),0.15);
  font-size:12px;color:var(--accent);font-weight:500;
  opacity:0;transition:all 0.3s cubic-bezier(0.16,1,0.3,1);pointer-events:none;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
/* Scrollbar */
::-webkit-scrollbar{width:3px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.06);border-radius:3px}
</style>
</head>
<body>
<div class="bg-glow"></div>

<div class="header">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
    <line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
  </svg>
  <h1>Fisilti</h1>
  <div class="header-right">
    <button class="icon-btn" id="soundBtn" title="Bildirim sesi">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
    </button>
    <button class="icon-btn" id="fullscreenBtn" title="Tam ekran">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
    </button>
  </div>
</div>

<div class="status-bar">
  <div id="statusDot" class="status-dot connecting"></div>
  <div class="pulse-ring hidden" id="pulseRing"></div>
  <span id="statusText" class="status-text">Hazırlaniyor...</span>
  <span id="statusMeta" class="status-meta"></span>
</div>

<div id="errorBox" class="error-box" style="display:none"></div>

<div id="transcriptArea" class="transcript-area">
  <div class="empty-state" id="emptyState">
    <div class="empty-icon">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="rgba(var(--accent-rgb),0.3)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
      </svg>
    </div>
    <span class="title">Baglanti bekleniyor</span>
    <span class="desc">Masaustu uygulamasindan konusmaya basladiginizda metin burada gorunecek</span>
  </div>
</div>

<div class="bottom-bar" id="bottomBar" style="display:none">
  <div class="stats">
    <span id="wordCount">0 kelime</span>
    <span id="duration">00:00</span>
  </div>
  <button class="action-btn copy" id="copyBtn">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
    Kopyala
  </button>
  <button class="action-btn share" id="shareBtn">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
    Paylas
  </button>
</div>

<div class="toast" id="toast"></div>

<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<script>
(function(){
  // Peer ID kaynagi: 1) Sunucu tarafindan gomulu, 2) URL query parametresi
  var EMBEDDED_ID = "{{PEER_ID}}";
  var urlParams = new URLSearchParams(window.location.search);
  var PEER_ID = (EMBEDDED_ID && EMBEDDED_ID !== "{{" + "PEER_ID" + "}}") ? EMBEDDED_ID : (urlParams.get("peer") || "");

  var dot = document.getElementById("statusDot");
  var txt = document.getElementById("statusText");
  var meta = document.getElementById("statusMeta");
  var area = document.getElementById("transcriptArea");
  var empty = document.getElementById("emptyState");
  var errorBox = document.getElementById("errorBox");
  var pulseRing = document.getElementById("pulseRing");
  var bottomBar = document.getElementById("bottomBar");
  var wordCountEl = document.getElementById("wordCount");
  var durationEl = document.getElementById("duration");
  var toastEl = document.getElementById("toast");

  var peer = null, conn = null;
  var attempt = 0, MAX_ATTEMPTS = 25, BASE_DELAY = 800;
  var allText = "", msgCount = 0, startTime = null;
  var soundEnabled = false, durationTimer = null;

  // ICE sunuculari — guvenilir baglanti icin
  var ICE_CONFIG = {
    config: {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        { urls: "stun:stun1.l.google.com:19302" },
        { urls: "stun:stun2.l.google.com:19302" },
        { urls: "stun:stun3.l.google.com:19302" },
        { urls: "stun:stun4.l.google.com:19302" },
      ]
    }
  };

  // ── Yardimcilar ──
  function setStatus(state, msg){
    dot.className = "status-dot " + state;
    txt.textContent = msg;
    pulseRing.className = "pulse-ring" + (state === "connected" ? "" : " hidden");
  }
  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(function(){ toastEl.classList.remove("show"); }, 2000);
  }
  function vibrate(ms){ try{ navigator.vibrate && navigator.vibrate(ms); }catch(e){} }
  function playTick(){
    if(!soundEnabled) return;
    try{
      var ctx = new (window.AudioContext || window.webkitAudioContext)();
      var osc = ctx.createOscillator();
      var gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.frequency.value = 880; osc.type = "sine";
      gain.gain.setValueAtTime(0.08, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
      osc.start(); osc.stop(ctx.currentTime + 0.1);
    }catch(e){}
  }
  function escapeHtml(s){
    var d = document.createElement("div");
    d.appendChild(document.createTextNode(s));
    return d.innerHTML;
  }
  function timeStr(){
    var d = new Date();
    return String(d.getHours()).padStart(2,"0") + ":" + String(d.getMinutes()).padStart(2,"0");
  }
  function updateDuration(){
    if(!startTime) return;
    var s = Math.floor((Date.now() - startTime) / 1000);
    var m = Math.floor(s / 60); s = s % 60;
    durationEl.textContent = String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
  }
  function updateWordCount(){
    var words = allText.trim().split(/\s+/).filter(Boolean).length;
    wordCountEl.textContent = words + " kelime";
  }
  function showError(title, desc){
    area.style.display = "none";
    errorBox.style.display = "block";
    errorBox.innerHTML = '<h2>' + title + '</h2><p>' + desc + '</p>' +
      '<button class="retry-btn" onclick="location.reload()">Yeniden Dene</button>';
  }

  function showTranscript(text){
    if(!text || text === allText) return;
    allText = text;
    if(!startTime) {
      startTime = Date.now();
      durationTimer = setInterval(updateDuration, 1000);
    }
    empty.style.display = "none";
    bottomBar.style.display = "flex";

    // Her satiri ayri bir mesaj blogu olarak goster
    var lines = text.split("\n").filter(Boolean);
    var html = "";
    for(var i = 0; i < lines.length; i++){
      html += '<div class="msg-block">' +
        '<div class="time">' + timeStr() + '</div>' +
        '<div class="text">' + escapeHtml(lines[i]) + '</div></div>';
    }
    area.innerHTML = html;
    area.scrollTop = area.scrollHeight;
    updateWordCount();

    // Bildirim efektleri
    vibrate([30, 20, 30]);
    playTick();
  }

  // ── Baglanti ──
  function connect(){
    if(attempt >= MAX_ATTEMPTS){
      setStatus("disconnected", "Baglanti kurulamadi");
      showError(
        "Baglanti Basarisiz",
        "Masaustu uygulamasina ulasilamadi. Oturumun aktif oldugunu kontrol edip tekrar deneyin."
      );
      return;
    }
    attempt++;
    var delay = Math.min(BASE_DELAY * Math.pow(1.4, attempt - 1), 12000);
    setStatus("connecting", "Baglaniyor... (" + attempt + ". deneme)");
    meta.textContent = "";

    if(peer){ try{ peer.destroy(); }catch(e){} }

    peer = new Peer(ICE_CONFIG);

    peer.on("open", function(myId){
      meta.textContent = "ID: " + myId.slice(0, 8);
      conn = peer.connect(PEER_ID, { reliable: true, serialization: "json" });

      conn.on("open", function(){
        attempt = 0;
        setStatus("connected", "Canli baglanti aktif");
        showToast("Baglanildi!");
        vibrate(50);
        conn.send({ type: "peer-join", peerId: peer.id, name: "Mobil Tarayici" });
      });

      conn.on("data", function(data){
        if(data && data.type === "transcript"){
          showTranscript(data.text || "");
        }
      });

      conn.on("close", function(){
        setStatus("disconnected", "Baglanti kesildi");
        showToast("Baglanti kesildi, yeniden deneniyor...");
        setTimeout(connect, delay);
      });

      conn.on("error", function(err){
        console.warn("Conn error:", err);
        setTimeout(connect, delay);
      });
    });

    peer.on("error", function(err){
      var t = err.type || "";
      if(t === "peer-unavailable"){
        setStatus("connecting", "Oturum aranıyor...");
      } else if(t === "network" || t === "server-error" || t === "socket-error" || t === "socket-closed"){
        setStatus("disconnected", "Ag hatasi, yeniden deneniyor...");
      } else {
        setStatus("disconnected", "Hata: " + t);
      }
      setTimeout(connect, delay);
    });

    peer.on("disconnected", function(){
      if(!peer.destroyed) peer.reconnect();
    });
  }

  // ── Butonlar ──
  document.getElementById("soundBtn").onclick = function(){
    soundEnabled = !soundEnabled;
    this.classList.toggle("active", soundEnabled);
    showToast(soundEnabled ? "Ses acik" : "Ses kapali");
    if(soundEnabled) playTick();
  };
  document.getElementById("fullscreenBtn").onclick = function(){
    if(!document.fullscreenElement){
      document.documentElement.requestFullscreen().catch(function(){});
      showToast("Tam ekran");
    } else {
      document.exitFullscreen();
    }
  };
  document.getElementById("copyBtn").onclick = function(){
    if(!allText) return;
    if(navigator.clipboard){
      navigator.clipboard.writeText(allText).then(function(){
        showToast("Metin kopyalandi!");
        vibrate(30);
      });
    }
  };
  document.getElementById("shareBtn").onclick = function(){
    if(!allText) return;
    if(navigator.share){
      navigator.share({ title: "Fisilti Transkripsiyon", text: allText }).catch(function(){});
    } else if(navigator.clipboard){
      navigator.clipboard.writeText(allText).then(function(){
        showToast("Metin kopyalandi — yapistirarak paylasin");
      });
    }
  };

  // ── Baslat ──
  if(typeof Peer === "undefined"){
    setStatus("disconnected", "Yukleme hatasi");
    showError("PeerJS Yuklenemedi", "Internet baglantinizi kontrol edin ve sayfayi yenileyin.");
    return;
  }
  if(!PEER_ID){
    setStatus("disconnected", "Oturum bilgisi eksik");
    showError("Oturum Bulunamadi", "Bu baglantida oturum kimligi eksik. Masaustu uygulamasindan paylasilan linki kullanin.");
    return;
  }
  connect();
})();
</script>
</body>
</html>
